<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intelligence Submission App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        html, body, #root { height: 100%; margin: 0; padding: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
        @keyframes ping { 75%, 100% { transform: scale(2); opacity: 0; } }
        .animate-ping { animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: #1F2937; color: #E5E7EB; border-radius: 8px; border: 1px solid #4B5563; }
        .loader { width: 1em; height: 1em; border-radius: 50%; display: inline-block; border-top: 2px solid #67e8f9; border-right: 2px solid transparent; box-sizing: border-box; animation: rotation 1s linear infinite; margin-right: 8px; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="text/babel">
        // --- FIX: Define a base URL for all API calls ---
        const API_BASE_URL = window.location.origin;

        const MapPinIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="inline-block w-5 h-5 mr-2 text-sky-400"><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const EventTypeIcon = ({ type }) => { const icons = { Police: 'üöî', Military: 'ü™ñ', Checkpoint: 'üöß', Protest: 'üó£Ô∏è', Arrest: '‚öñÔ∏è', Other: '‚ùì' }; return <span className="text-2xl">{icons[type] || '‚ùì'}</span>; };

        function createReportIcon(color) { const html = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${color}" class="w-7 h-7 drop-shadow-md opacity-80"><path d="M12 1.5a5.25 5.25 0 00-5.25 5.25c0 3.63 2.56 7.8 4.63 9.94a.75.75 0 001.24 0c2.07-2.14 4.63-6.31 4.63-9.94A5.25 5.25 0 0012 1.5zM12 9a1.5 1.5 0 100-3 1.5 1.5 0 000 3z" /></svg>`; return L.divIcon({ html, className: 'dummy', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] }); }
        const reportIcons = { 'Police': createReportIcon('#3b82f6'), 'Military': createReportIcon('#22c55e'), 'Checkpoint': createReportIcon('#eab308'), 'Protest': createReportIcon('#ef4444'), 'Other': createReportIcon('#a855f7'), 'Default': createReportIcon('#6b7280') };
        function createUserIcon() { const html = `<div class="relative flex items-center justify-center w-5 h-5"><div class="absolute w-full h-full bg-sky-400 rounded-full animate-ping"></div><div class="relative w-3 h-3 bg-sky-300 rounded-full border-2 border-white shadow-md"></div></div>`; return L.divIcon({ html, className: 'dummy', iconSize: [20, 20], iconAnchor: [10, 10] }); }
        function createSelectionIcon() { const html = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="#facc15" class="w-8 h-8 drop-shadow-lg"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12h18M12 3v18" /></svg>`; return L.divIcon({ html, className: 'dummy', iconSize: [32, 32], iconAnchor: [16, 16] }); }
        
        const MapView = ({ reports, userLocation, selectedLocation, onMapClick, onLocateUser }) => {
            const mapRef = React.useRef(null);
            const userMarkerRef = React.useRef(null);
            const selectionMarkerRef = React.useRef(null);
            const reportMarkersRef = React.useRef({});

            React.useEffect(() => {
                if (!mapRef.current) {
                    const map = L.map('map-container').setView(userLocation, 15);
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 20 }).addTo(map);
                    map.on('click', (e) => onMapClick(e.latlng));
                    mapRef.current = map;
                    setTimeout(() => map.invalidateSize(), 0);
                }
            }, []);
            
            React.useEffect(() => {
                const map = mapRef.current; if (!map) return;
                const currentMarkers = reportMarkersRef.current;
                const newMarkers = {};
                reports.forEach(report => {
                    if (currentMarkers[report.id]) {
                        newMarkers[report.id] = currentMarkers[report.id];
                        delete currentMarkers[report.id];
                    } else {
                        const marker = L.marker(report.location, { icon: reportIcons[report.type] || reportIcons.Default });
                        marker.bindPopup(`<div class="font-sans text-gray-200"><h3 class="font-bold text-md text-white">${report.type}</h3><p>${report.description || 'No description'}</p></div>`);
                        marker.addTo(map);
                        newMarkers[report.id] = marker;
                    }
                });
                Object.values(currentMarkers).forEach(marker => map.removeLayer(marker));
                reportMarkersRef.current = newMarkers;
            }, [reports]);

            React.useEffect(() => {
                const map = mapRef.current; if (!map) return;
                if (userMarkerRef.current) { userMarkerRef.current.setLatLng(userLocation); } 
                else { userMarkerRef.current = L.marker(userLocation, { icon: createUserIcon(), zIndexOffset: 1000 }).addTo(map); }
                
                if (selectedLocation) {
                    if (selectionMarkerRef.current) {
                        selectionMarkerRef.current.setLatLng(selectedLocation).addTo(map);
                    } else {
                        selectionMarkerRef.current = L.marker(selectedLocation, { icon: createSelectionIcon(), zIndexOffset: 999, interactive: false }).addTo(map);
                    }
                } else if(selectionMarkerRef.current) {
                    map.removeLayer(selectionMarkerRef.current);
                    selectionMarkerRef.current = null;
                }
            }, [userLocation, selectedLocation]);
            
            const handleFlyTo = React.useCallback(() => { if (mapRef.current) mapRef.current.flyTo(userLocation, 16); }, [userLocation]);
            React.useEffect(() => { handleFlyTo(); }, [handleFlyTo]);

            return (
                <div className="w-full h-full relative">
                    <div id="map-container" className="w-full h-full bg-gray-800 rounded-lg border border-gray-700 shadow-inner" />
                    <button onClick={onLocateUser} className="absolute top-2 left-2 z-[1000] bg-gray-800/80 backdrop-blur-sm text-white p-2.5 rounded-lg shadow-lg hover:bg-gray-700 transition-colors"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" className="w-6 h-6"><path strokeLinecap="round" strokeLinejoin="round" d="M12 8.25v-1.5m0 1.5c-1.355 0-2.697.056-4.024.166C6.845 8.51 6 9.473 6 10.608v2.785c0 1.135.845 2.098 1.976 2.192.324.028.652.042.98.053 1.326.012 2.67.012 4.024 0 .328-.011.656-.025.98-.053 1.131-.094 1.976-1.057 1.976-2.192v-2.785c0-1.135-.845-2.098-1.976-2.192A48.424 48.424 0 0012 8.25z" /></svg></button>
                </div>
            );
        };

        const MainView = ({ onNewReport, locationName, reports, userLocation, selectedLocation, onMapClick, isGeocoding, onLocateUser }) => (
            <div className="p-4 flex flex-col h-full">
                <div className="flex-grow flex flex-col min-h-0">
                    <p className="text-center pb-2 text-gray-300 font-semibold">Tap map or use GPS to select location</p>
                    <div className="relative flex-grow mb-4"><MapView reports={reports} userLocation={userLocation} selectedLocation={selectedLocation} onMapClick={onMapClick} onLocateUser={onLocateUser} /></div>
                    <div className="text-center w-full flex-shrink-0 h-14"><p className="text-sm text-gray-400">Report Location:</p><div className="font-semibold text-lg text-yellow-400 flex items-center justify-center">{isGeocoding && <span className="loader"></span>}<span>{locationName}</span></div></div>
                </div>
                <div className="py-2 flex-shrink-0"><button onClick={onNewReport} disabled={!selectedLocation || isGeocoding} className="w-full bg-sky-600 hover:bg-sky-700 disabled:bg-gray-600 text-white font-bold py-4 px-4 rounded-lg text-xl shadow-lg">[+] New Report</button></div>
            </div>
        );

        const ReportForm = ({ onFormSubmit, onBack, locationName, granularity, onGranularityChange, formData, onFormChange, description, onDescriptionChange }) => {
            const { eventType, eventSubType, personnelCount, vehicleCount, confidenceLevel, isUrgent } = formData;
            const eventTypes = ['Police', 'Military', 'Checkpoint', 'Protest', 'Arrest', 'Other'];
            const eventSubTypes = { Police: ['Patrol', 'Traffic Stop', 'Riot Control', 'Arrest', 'Raid'], Military: ['Convoy', 'Patrol', 'Guard Post', 'Recruiting'], Checkpoint: ['ID Check', 'Vehicle Search', 'Roadblock', 'Temporary'] };
            const countOptions = ['1-5', '6-20', '21-50', '50+'];
            const vehicleCountOptions = ['0', '1-2', '3-10', '11-25', '25+'];
            const confidenceOptions = ['Low', 'Medium', 'High'];

            return (
                <div className="p-4 flex flex-col h-full">
                    <div className="flex-none flex justify-between items-center pb-4"><button onClick={onBack} className="text-sky-400 hover:text-sky-300">&lt; Back to Map</button><h1 className="font-bold text-xl text-gray-100">Submit Report</h1><div className="w-24"></div></div>
                    <div className="flex-grow overflow-y-auto space-y-5 pr-2">
                        <div>
                            <label className="text-gray-400 font-semibold block mb-2">Location & Precision</label>
                            <div className="flex items-center bg-gray-800 p-3 rounded-lg border border-gray-700 mb-2">
                                <MapPinIcon /><span className="flex-grow text-yellow-400 font-mono text-sm">{locationName}</span><button onClick={onBack} className="text-sm text-sky-400 hover:text-sky-300 ml-2 flex-shrink-0">Update</button>
                            </div>
                            <div className="flex flex-wrap gap-2">{['Exact', 'Block', 'District', 'Zip Code'].map(level => (<button key={level} onClick={() => onGranularityChange(level)} className={`px-3 py-1 text-xs font-semibold rounded-full ${granularity === level ? 'bg-yellow-400 text-gray-900' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{level}</button>))}</div>
                        </div>
                        <div>
                            <label className="text-gray-400 font-semibold block mb-2">Event Type</label>
                            <div className="grid grid-cols-3 gap-2">{eventTypes.map(type => (<button key={type} onClick={() => onFormChange('eventType', type)} className={`p-2 rounded-lg border-2 flex flex-col items-center justify-center ${eventType === type ? 'bg-sky-600 border-sky-500' : 'bg-gray-800 border-gray-700 hover:border-gray-500'}`}><EventTypeIcon type={type} /><span className="block text-xs mt-1 font-semibold">{type}</span></button>))}</div>
                        </div>
                        {eventSubTypes[eventType] && ( <div> <label className="text-gray-400 font-semibold block mb-2">Details</label> <div className="flex flex-wrap gap-2">{eventSubTypes[eventType].map(subType => (<button key={subType} onClick={() => onFormChange('eventSubType', subType)} className={`px-3 py-1 text-sm font-semibold rounded-full ${eventSubType === subType ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{subType}</button>))}</div> </div> )}
                        <div>
                             <label className="text-gray-400 font-semibold block mb-2">Quantify (Approx.)</label>
                             <div className="space-y-2">
                                <div className="flex items-center gap-2"><span className="w-16 text-sm text-gray-300">Personnel</span><div className="flex flex-wrap gap-2">{countOptions.map(count => (<button key={count} onClick={() => onFormChange('personnelCount', count)} className={`px-3 py-1 text-sm font-semibold rounded-full ${personnelCount === count ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{count}</button>))}</div></div>
                                <div className="flex items-center gap-2"><span className="w-16 text-sm text-gray-300">Vehicles</span><div className="flex flex-wrap gap-2">{vehicleCountOptions.map(count => (<button key={count} onClick={() => onFormChange('vehicleCount', count)} className={`px-3 py-1 text-sm font-semibold rounded-full ${vehicleCount === count ? 'bg-sky-500 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{count}</button>))}</div></div>
                             </div>
                        </div>
                        <div><label className="text-gray-400 font-semibold block mb-2">Description</label><textarea value={description} onChange={onDescriptionChange} className="w-full bg-gray-800 p-3 rounded-lg border border-gray-700" placeholder="Add any other important details..."></textarea></div>
                        <div>
                            <label className="text-gray-400 font-semibold block mb-2">Your Confidence</label>
                            <div className="grid grid-cols-3 gap-2">{confidenceOptions.map(level => (<button key={level} onClick={() => onFormChange('confidenceLevel', level)} className={`px-3 py-2 text-sm font-semibold rounded-lg ${confidenceLevel === level ? 'bg-yellow-400 text-gray-900' : 'bg-gray-700 text-gray-300 hover:bg-gray-600'}`}>{level}</button>))}</div>
                        </div>
                        <div className="flex items-center space-x-3 pt-2">
                            <input id="urgent-checkbox" type="checkbox" checked={isUrgent} onChange={(e) => onFormChange('isUrgent', e.target.checked)} className="h-5 w-5 rounded bg-gray-700 border-gray-600 text-red-500 focus:ring-red-600" />
                            <label htmlFor="urgent-checkbox" className="text-red-400 font-semibold">This event is in progress / Urgent</label>
                        </div>
                    </div>
                    <div className="flex-none pt-4"><button onClick={onFormSubmit} className="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-4 px-4 rounded-lg text-lg shadow-lg">Submit Report</button></div>
                </div>
            );
        };
        
        const ConfirmationView = ({ onNewReport, onClose }) => ( <div className="p-4 flex flex-col h-full items-center justify-center text-center"><div className="text-7xl mb-4">‚úÖ</div><h1 className="text-2xl font-bold text-white mb-2">Report Received</h1><p className="text-gray-400 mb-8 font-semibold">All personal metadata has been removed.</p><div className="w-full max-w-xs space-y-3"><button onClick={onNewReport} className="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg text-lg">Submit Another Report</button><button onClick={onClose} className="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-3 px-4 rounded-lg">Close</button></div></div>);

        const defaultFormState = { eventType: '', eventSubType: '', personnelCount: '', vehicleCount: '', confidenceLevel: 'Medium', isUrgent: false };

        function App() {
            const [view, setView] = React.useState('main');
            const [reports, setReports] = React.useState([]);
            const [userLocation, setUserLocation] = React.useState({ lat: 42.464, lng: -83.138 });
            const [selectedLocation, setSelectedLocation] = React.useState(null);
            const [granularity, setGranularity] = React.useState('Exact');
            const [locationName, setLocationName] = React.useState('Initializing...');
            const [locationDetails, setLocationDetails] = React.useState(null);
            const [isGeocoding, setIsGeocoding] = React.useState(true);
            const [formData, setFormData] = React.useState(defaultFormState);
            const [description, setDescription] = React.useState('');
            
            const fetchReports = async () => {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reports`);
                    const data = await response.json();
                    setReports(data);
                } catch (error) {
                    console.error('Failed to fetch reports:', error);
                }
            };
            
            const handleFormSubmit = async () => {
                const payload = { ...formData, description, granularity, location: selectedLocation };
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reports`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('Failed to submit report');
                    setView('confirmation');
                    fetchReports(); // Refresh reports after submission
                } catch (error) {
                    console.error('Submission error:', error);
                    alert('Failed to submit report.');
                }
            };

            const handleFormChange = (field, value) => {
                if (field === 'eventType') {
                    setFormData(prev => ({...prev, eventType: value, eventSubType: ''}));
                } else {
                    setFormData(prev => ({ ...prev, [field]: value }));
                }
            };
            
            const handleStartNewReport = () => {
                setFormData(defaultFormState);
                setDescription('');
                setView('form');
            }

            const fetchLocationDetails = async (latlng) => {
                setIsGeocoding(true);
                setLocationName('Fetching address...');
                try {
                    const response = await fetch(`${API_BASE_URL}/api/reverse-geocode?lat=${latlng.lat}&lon=${latlng.lng}`);
                    if (!response.ok) throw new Error('Network response failed');
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    setLocationDetails(data && data.address ? data.address : { error: 'Address not found.' });
                } catch (error) {
                    console.error("Failed to fetch address:", error);
                    setLocationDetails({ error: 'Could not fetch address.' });
                } finally {
                    setIsGeocoding(false);
                }
            };

            const handleMapClick = (latlng) => {
                setSelectedLocation(latlng);
                setGranularity('Exact');
                fetchLocationDetails(latlng);
            };
            
            const handleLocateUser = () => {
                if (!navigator.geolocation) {
                    setLocationName("Geolocation is not supported");
                    return;
                }
                setIsGeocoding(true);
                setLocationName("Getting your location...");
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const newLocation = { lat: latitude, lng: longitude };
                        setUserLocation(newLocation);
                        setSelectedLocation(newLocation);
                        setGranularity('Exact');
                        fetchLocationDetails(newLocation);
                    },
                    () => {
                        setLocationName("Unable to retrieve your location.");
                        setIsGeocoding(false);
                    },
                    { enableHighAccuracy: true }
                );
            };
            
            React.useEffect(() => {
                handleLocateUser();
                fetchReports();
            }, []);

            React.useEffect(() => {
                if (isGeocoding || !locationDetails) return;
                if (locationDetails.error) {
                    setLocationName(locationDetails.error);
                    return;
                }
                let name = 'N/A';
                switch(granularity) {
                    case 'Block': name = locationDetails.road || 'N/A'; break;
                    case 'District': name = locationDetails.suburb || locationDetails.neighbourhood || 'N/A'; break;
                    case 'Zip Code': name = locationDetails.postcode || 'N/A'; break;
                    case 'Municipality': name = locationDetails.city || locationDetails.town || locationDetails.village || 'N/A'; break;
                    case 'County': name = locationDetails.county || 'N/A'; break;
                    case 'State': name = locationDetails.state || 'N/A'; break;
                    case 'Exact': default: name = `${selectedLocation.lat.toFixed(5)}, ${selectedLocation.lng.toFixed(5)}`;
                }
                setLocationName(name);
            }, [selectedLocation, granularity, locationDetails, isGeocoding]);
            
            const renderView = () => {
                switch (view) {
                    case 'form': return <ReportForm onFormSubmit={handleFormSubmit} onBack={() => setView('main')} locationName={locationName} granularity={granularity} onGranularityChange={setGranularity} formData={formData} onFormChange={handleFormChange} description={description} onDescriptionChange={(e) => setDescription(e.target.value)} />;
                    case 'confirmation': return <ConfirmationView onNewReport={handleStartNewReport} onClose={() => setView('main')} />;
                    default: return <MainView onNewReport={handleStartNewReport} locationName={locationName} reports={reports} userLocation={userLocation} selectedLocation={selectedLocation} onMapClick={handleMapClick} isGeocoding={isGeocoding} onLocateUser={handleLocateUser} />;
                }
            };

            return (<main className="bg-gray-900 text-gray-200 h-screen w-screen"><div className="max-w-md mx-auto h-full bg-gray-900 shadow-2xl">{renderView()}</div></main>);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

